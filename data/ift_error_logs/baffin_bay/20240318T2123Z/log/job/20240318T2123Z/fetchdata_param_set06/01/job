#!/bin/bash -l
#
# ++++ THIS IS A CYLC JOB SCRIPT ++++
# Workflow: baffin_bay/run3
# Task: 20240318T2123Z/fetchdata_param_set06
# Job log directory: 20240318T2123Z/fetchdata_param_set06/01
# Job runner: slurm
# Execution time limit: 3600.0

# DIRECTIVES:
#SBATCH --job-name=fetchdata_param_set06.20240318T2123Z.baffin_bay/run3
#SBATCH --output=cylc-run/baffin_bay/run3/log/job/20240318T2123Z/fetchdata_param_set06/01/job.out
#SBATCH --error=cylc-run/baffin_bay/run3/log/job/20240318T2123Z/fetchdata_param_set06/01/job.err
#SBATCH --time=60:00
#SBATCH --mem=12G
#SBATCH --cpus-per-task=4
if [[ $1 == 'noreinvoke' ]]; then
    shift
else
    exec bash -l "$0" noreinvoke "$@"
fi

CYLC_FAIL_SIGNALS='EXIT ERR TERM XCPU'
export CYLC_VERBOSE=false
export CYLC_DEBUG=false
export CYLC_VERSION='8.2.1'
export CYLC_WORKFLOW_ID="baffin_bay/run3"

cylc__job__inst__cylc_env() {
    # CYLC WORKFLOW ENVIRONMENT:
    export CYLC_CYCLING_MODE="gregorian"
    export CYLC_UTC="False"
    export CYLC_WORKFLOW_FINAL_CYCLE_POINT="None"
    export CYLC_WORKFLOW_INITIAL_CYCLE_POINT="20240318T2123Z"
    export CYLC_WORKFLOW_NAME="baffin_bay"
    export CYLC_WORKFLOW_NAME_BASE="baffin_bay"
    export CYLC_WORKFLOW_UUID="58bad15e-ae84-4052-9b16-fd5ca351fc36"

    # CYLC TASK ENVIRONMENT:
    export CYLC_TASK_COMMS_METHOD=zmq
    export CYLC_TASK_JOB="20240318T2123Z/fetchdata_param_set06/01"
    export CYLC_TASK_NAMESPACE_HIERARCHY="root fetchdata_param_set06"
    export CYLC_TASK_DEPENDENCIES="20240318T2123Z/pullfetchimage 20240318T2123Z/pulljuliaimage"
    export CYLC_TASK_TRY_NUMBER=1
    export CYLC_TASK_FLOW_NUMBERS=1
    export CYLC_TASK_PARAM_param_set="6"
}

cylc__job__inst__user_env() {
    # TASK RUNTIME ENVIRONMENT:
    export location startdate enddate crs bounding_box centroid_lat centroid_lon minfloearea maxfloearea project_dir t julia_exec report_dir results_dir fetchdata_dir truecolor_dir falsecolor_dir
    location="baffin_bay-100km_by_100km-20040725-20040726,baffin_bay-100km_by_100km-20040921-20040922,baffin_bay-100km_by_100km-20050819-20050820,baffin_bay-100km_by_100km-20050827-20050828,baffin_bay-100km_by_100km-20070605-20070606,baffin_bay-100km_by_100km-20080704-20080705,baffin_bay-100km_by_100km-20090426-20090427,baffin_bay-100km_by_100km-20110506-20110507,baffin_bay-100km_by_100km-20120419-20120420,baffin_bay-100km_by_100km-20120422-20120423,baffin_bay-100km_by_100km-20130308-20130309,baffin_bay-100km_by_100km-20140329-20140330,baffin_bay-100km_by_100km-20150312-20150313,baffin_bay-100km_by_100km-20160708-20160709,baffin_bay-100km_by_100km-20190523-20190524,baffin_bay-100km_by_100km-20190925-20190926,baffin_bay-100km_by_100km-20210602-20210603,baffin_bay-100km_by_100km-20210804-20210805,baffin_bay-100km_by_100km-20220530-20220531,baffin_bay-100km_by_100km-20220617-20220618,baffin_bay-100km_by_100km-20220911-20220912"
    startdate="2004-07-25,2004-09-21,2005-08-19,2005-08-27,2007-06-05,2008-07-04,2009-04-26,2011-05-06,2012-04-19,2012-04-22,2013-03-08,2014-03-29,2015-03-12,2016-07-08,2019-05-23,2019-09-25,2021-06-02,2021-08-04,2022-05-30,2022-06-17,2022-09-11"
    enddate="2004-07-26,2004-09-22,2005-08-20,2005-08-28,2007-06-06,2008-07-05,2009-04-27,2011-05-07,2012-04-20,2012-04-23,2013-03-09,2014-03-30,2015-03-13,2016-07-09,2019-05-24,2019-09-26,2021-06-03,2021-08-05,2022-05-31,2022-06-18,2022-09-12"
    crs="epsg3413"
    bounding_box="-812499.99995@-2012499.99961@-712499.99995@-2112499.99961,-1187500.00003@-2062499.99971@-1087500.00003@-2162499.99971,-1087500.00035@-1112500.00038@-987500.00035@-1212500.00038,-1112499.99986@-887500.00004@-1012499.99986@-987500.00004,-612499.99998@-1512500.00033@-512499.99998@-1612500.00033,-737500.00005@-1987500.00039@-637500.00005@-2087500.00039,-512499.99995@-962499.99985@-412499.99995@-1062499.99985,-662499.99975@-1137499.99971@-562499.99975@-1237499.99971,-937499.9998@-1237499.99987@-837499.9998@-1337499.99987,-687499.99983@-1187499.99993@-587499.99983@-1287499.99993,-687500.00024@-1062500.00032@-587500.00024@-1162500.00032,-462499.9999@-2087499.99947@-362499.9999@-2187499.99947,-962500.00003@-1162500.00001@-862500.00003@-1262500.00001,-487499.99992@-1412499.99945@-387499.99992@-1512499.99945,-1162499.99993@-1312500.00001@-1062499.99993@-1412500.00001,-662500.00016@-937500.00017@-562500.00016@-1037500.00017,-762500.00012@-1337499.99997@-662500.00012@-1437499.99997,-462499.99995@-912500.00006@-362499.99995@-1012500.00006,-812499.99988@-1362499.99975@-712499.99988@-1462499.99975,-1037500.00018@-1362500.00049@-937500.00018@-1462500.00049,-1012499.99994@-862500.00001@-912499.99994@-962500.00001"
    centroid_lat="69.90135406,68.11094967,75.68820789,76.97365651,74.75683661,70.33687935,79.75068046,77.71099328,75.63723536,77.20090338,78.20371977,70.09851434,76.05793463,75.97572566,73.86538925,79.30290332,75.67362506,80.35520852,75.26078557,74.18734019,77.80101347"
    centroid_lon="-65.28920054,-73.30075577,-86.7480544,-93.57633437,-64.79887635,-63.64559412,-69.55045239,-72.28420729,-79.5792876,-72.25532837,-74.81416274,-55.92280472,-81.96428929,-61.65430638,-84.2321111,-76.80938929,-72.18111109,-68.19859051,-73.36119433,-79.95797636,-91.52752544"
    minfloearea="100"
    maxfloearea="90000"
    project_dir=~/"ice-floe-tracker-pipeline"
    t="${CYLC_WORKFLOW_INITIAL_CYCLE_POINT}"
    julia_exec="/usr/local/julia/bin/julia"
    report_dir="$project_dir/"workflow/report""
    results_dir="$project_dir/"results"/$t"
    fetchdata_dir="$project_dir/"resources"/$t"
    truecolor_dir="$fetchdata_dir/"truecolor""
    falsecolor_dir="$fetchdata_dir/"falsecolor""
}

cylc__job__inst__script() {
# SCRIPT:
i=${CYLC_TASK_PARAM_param_set}
bbox_array=( $(echo $bounding_box | sed -e 's/,/ /g') )
location_array=( $(echo $location | sed -e 's/,/ /g') )
startdate_array=( $(echo $startdate | sed -e 's/,/ /g') )
enddate_array=( $(echo $enddate | sed -e 's/,/ /g') )

apptainer exec --bind $fetchdata_dir/${location_array[$i]}:/tmp $project_dir/fetchdata.simg /usr/local/bin/fetchdata.sh -o /tmp -s ${startdate_array[$i]} -e ${enddate_array[$i]} -c $crs -b ${bbox_array[$i]}
}

CYLC_RUN_DIR="${CYLC_RUN_DIR:-$HOME/cylc-run}"
. "${CYLC_RUN_DIR}/${CYLC_WORKFLOW_ID}/.service/etc/job.sh"
cylc__job__main

#EOF: 20240318T2123Z/fetchdata_param_set06/01
