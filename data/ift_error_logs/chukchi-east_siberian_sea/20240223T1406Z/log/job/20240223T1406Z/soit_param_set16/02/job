#!/bin/bash -l
#
# ++++ THIS IS A CYLC JOB SCRIPT ++++
# Workflow: chukchi-east_siberian_sea/run1
# Task: 20240223T1406Z/soit_param_set16
# Job log directory: 20240223T1406Z/soit_param_set16/02
# Job runner: slurm
# Execution time limit: 3600.0

# DIRECTIVES:
#SBATCH --job-name=soit_param_set16.20240223T1406Z.chukchi-east_siberian_sea/run1
#SBATCH --output=cylc-run/chukchi-east_siberian_sea/run1/log/job/20240223T1406Z/soit_param_set16/02/job.out
#SBATCH --error=cylc-run/chukchi-east_siberian_sea/run1/log/job/20240223T1406Z/soit_param_set16/02/job.err
#SBATCH --time=60:00
#SBATCH --mem=12G
#SBATCH --cpus-per-task=4
if [[ $1 == 'noreinvoke' ]]; then
    shift
else
    exec bash -l "$0" noreinvoke "$@"
fi

CYLC_FAIL_SIGNALS='EXIT ERR TERM XCPU'
export CYLC_VERBOSE=false
export CYLC_DEBUG=false
export CYLC_VERSION='8.2.1'
export CYLC_WORKFLOW_ID="chukchi-east_siberian_sea/run1"

cylc__job__inst__cylc_env() {
    # CYLC WORKFLOW ENVIRONMENT:
    export CYLC_CYCLING_MODE="gregorian"
    export CYLC_UTC="False"
    export CYLC_WORKFLOW_FINAL_CYCLE_POINT="None"
    export CYLC_WORKFLOW_INITIAL_CYCLE_POINT="20240223T1406Z"
    export CYLC_WORKFLOW_NAME="chukchi-east_siberian_sea"
    export CYLC_WORKFLOW_NAME_BASE="chukchi-east_siberian_sea"
    export CYLC_WORKFLOW_UUID="0049d196-0cd8-4750-a8f4-de706383adee"

    # CYLC TASK ENVIRONMENT:
    export CYLC_TASK_COMMS_METHOD=zmq
    export CYLC_TASK_JOB="20240223T1406Z/soit_param_set16/02"
    export CYLC_TASK_NAMESPACE_HIERARCHY="root soit_param_set16"
    export CYLC_TASK_DEPENDENCIES="20240223T1406Z/pullfetchimage 20240223T1406Z/pulljuliaimage"
    export CYLC_TASK_TRY_NUMBER=2
    export CYLC_TASK_FLOW_NUMBERS=1
    export CYLC_TASK_PARAM_param_set="16"
}

cylc__job__inst__user_env() {
    # TASK RUNTIME ENVIRONMENT:
    export location startdate enddate crs bounding_box centroid_x centroid_y minfloearea maxfloearea project_dir t julia_exec report_dir results_dir fetchdata_dir truecolor_dir reflectance_dir
    location="chukchi-east_siberian_sea-100km_by_100km-20040717-20040718,chukchi-east_siberian_sea-100km_by_100km-20050730-20050731,chukchi-east_siberian_sea-100km_by_100km-20060611-20060612,chukchi-east_siberian_sea-100km_by_100km-20060927-20060928,chukchi-east_siberian_sea-100km_by_100km-20070723-20070724,chukchi-east_siberian_sea-100km_by_100km-20090903-20090904,chukchi-east_siberian_sea-100km_by_100km-20100929-20100930,chukchi-east_siberian_sea-100km_by_100km-20140427-20140428,chukchi-east_siberian_sea-100km_by_100km-20140511-20140512,chukchi-east_siberian_sea-100km_by_100km-20140808-20140809,chukchi-east_siberian_sea-100km_by_100km-20150630-20150701,chukchi-east_siberian_sea-100km_by_100km-20160525-20160526,chukchi-east_siberian_sea-100km_by_100km-20170328-20170329,chukchi-east_siberian_sea-100km_by_100km-20170417-20170418,chukchi-east_siberian_sea-100km_by_100km-20180809-20180810,chukchi-east_siberian_sea-100km_by_100km-20180828-20180829,chukchi-east_siberian_sea-100km_by_100km-20190419-20190420,chukchi-east_siberian_sea-100km_by_100km-20190615-20190616,chukchi-east_siberian_sea-100km_by_100km-20200303-20200304,chukchi-east_siberian_sea-100km_by_100km-20200330-20200331,chukchi-east_siberian_sea-100km_by_100km-20220520-20220521"
    startdate="2004-07-17,2005-07-30,2006-06-11,2006-09-27,2007-07-23,2009-09-03,2010-09-29,2014-04-27,2014-05-11,2014-08-08,2015-06-30,2016-05-25,2017-03-28,2017-04-17,2018-08-09,2018-08-28,2019-04-19,2019-06-15,2020-03-03,2020-03-30,2022-05-20"
    enddate="2004-07-18,2005-07-31,2006-06-12,2006-09-28,2007-07-24,2009-09-04,2010-09-30,2014-04-28,2014-05-12,2014-08-09,2015-07-01,2016-05-26,2017-03-29,2017-04-18,2018-08-10,2018-08-29,2019-04-20,2019-06-16,2020-03-04,2020-03-31,2022-05-21"
    crs="epsg3413"
    bounding_box="-1312499.99878@1937500.00036@-1212499.99878@1837500.00036,-1187500.00017@1237500.00006@-1087500.00017@1137500.00006,-612499.99868@1637500.00011@-512499.99868@1537500.00011,-1412499.99956@1137500.00068@-1312499.99956@1037500.00068,-662499.99982@1437499.99958@-562499.99982@1337499.99958,-987499.9993@912500.00027@-887499.9993@812500.00027,-962500.00046@1312499.99954@-862500.00046@1212499.99954,-512500.00055@1537499.99972@-412500.00055@1437499.99972,-362500.00133@1537500.00006@-262500.00133@1437500.00006,-1512500.00074@1162499.9989@-1412500.00074@1062499.9989,-487500.00103@1612499.99917@-387500.00103@1512499.99917,-412499.99885@1587500.0007@-312499.99885@1487500.0007,-612500.00123@1762499.99928@-512500.00123@1662499.99928,-1412499.99856@1712500.00072@-1312499.99856@1612500.00072,-1087500.00005@1237500.00066@-987500.00005@1137500.00066,-1137500.00098@912499.99939@-1037500.00098@812499.99939,-362499.99969@1562500.00019@-262499.99969@1462500.00019,-562500.00051@1462500.00001@-462500.00051@1362500.00001,-487500.00091@1812499.99977@-387500.00091@1712499.99977,-1237500.00052@1812499.99917@-1137500.00052@1712499.99917,-487499.99934@1562500.00074@-387499.99934@1462500.00074"
    centroid_x="69.25793095,74.9044512,74.54322463,74.00763823,76.06543315,78.27969014,75.69185602,75.69185602,76.03546416,73.15462424,75.10248263,75.49262615,73.47142475,70.34470456,75.51782426,77.23781494,75.81279153,76.19355475,73.34954439,70.56254647,75.53945903"
    centroid_y="168.7775419,178.7680226,154.5107994,-173.5956473,158.8186505,-177.614056,170.8583598,152.2717426,146.8643905,-172.2596588,150.6422465,148.2664808,153.1836532,174.3362937,176.143199,-173.4180553,146.6737103,154.9423846,148.9405912,168.9704688,151.1328405"
    minfloearea="300"
    maxfloearea="90000"
    project_dir=~/"ice-floe-tracker-pipeline"
    t="${CYLC_WORKFLOW_INITIAL_CYCLE_POINT}"
    julia_exec="/usr/local/julia/bin/julia"
    report_dir="$project_dir/"workflow/report""
    results_dir="$project_dir/"results"/$t"
    fetchdata_dir="$project_dir/"resources"/$t"
    truecolor_dir="$fetchdata_dir/"truecolor""
    reflectance_dir="$fetchdata_dir/"reflectance""
}

cylc__job__inst__script() {
# SCRIPT:
i=${CYLC_TASK_PARAM_param_set}
location_array=( $(echo $location | sed -e 's/,/ /g') )
startdate_array=( $(echo $startdate | sed -e 's/,/ /g') )
enddate_array=( $(echo $enddate | sed -e 's/,/ /g') )
centroid_x_array=( $(echo $centroid_x| sed -e 's/,/ /g') )
centroid_y_array=( $(echo $centroid_y | sed -e 's/,/ /g') )

apptainer exec --bind $results_dir/${location_array[$i]}/soit:/tmp $project_dir/fetchdata.simg python3 /usr/local/bin/pass_time_cylc.py --startdate ${startdate_array[$i]} --enddate ${enddate_array[$i]} --csvoutpath /tmp --centroid_lat ${centroid_x_array[$i]} --centroid_lon ${centroid_y_array[$i]} --SPACEUSER $SPACEUSER --SPACEPSWD $SPACEPSWD
}

CYLC_RUN_DIR="${CYLC_RUN_DIR:-$HOME/cylc-run}"
. "${CYLC_RUN_DIR}/${CYLC_WORKFLOW_ID}/.service/etc/job.sh"
cylc__job__main

#EOF: 20240223T1406Z/soit_param_set16/02
