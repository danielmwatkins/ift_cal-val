#!/bin/bash -l
#
# ++++ THIS IS A CYLC JOB SCRIPT ++++
# Workflow: greenland_sea/run1
# Task: 20240223T1604Z/soit_param_set07
# Job log directory: 20240223T1604Z/soit_param_set07/01
# Job runner: slurm
# Execution time limit: 3600.0

# DIRECTIVES:
#SBATCH --job-name=soit_param_set07.20240223T1604Z.greenland_sea/run1
#SBATCH --output=cylc-run/greenland_sea/run1/log/job/20240223T1604Z/soit_param_set07/01/job.out
#SBATCH --error=cylc-run/greenland_sea/run1/log/job/20240223T1604Z/soit_param_set07/01/job.err
#SBATCH --time=60:00
#SBATCH --mem=12G
#SBATCH --cpus-per-task=4
if [[ $1 == 'noreinvoke' ]]; then
    shift
else
    exec bash -l "$0" noreinvoke "$@"
fi

CYLC_FAIL_SIGNALS='EXIT ERR TERM XCPU'
export CYLC_VERBOSE=false
export CYLC_DEBUG=false
export CYLC_VERSION='8.2.1'
export CYLC_WORKFLOW_ID="greenland_sea/run1"

cylc__job__inst__cylc_env() {
    # CYLC WORKFLOW ENVIRONMENT:
    export CYLC_CYCLING_MODE="gregorian"
    export CYLC_UTC="False"
    export CYLC_WORKFLOW_FINAL_CYCLE_POINT="None"
    export CYLC_WORKFLOW_INITIAL_CYCLE_POINT="20240223T1604Z"
    export CYLC_WORKFLOW_NAME="greenland_sea"
    export CYLC_WORKFLOW_NAME_BASE="greenland_sea"
    export CYLC_WORKFLOW_UUID="2c06a06d-f354-4a83-a15d-dd85635e6975"

    # CYLC TASK ENVIRONMENT:
    export CYLC_TASK_COMMS_METHOD=zmq
    export CYLC_TASK_JOB="20240223T1604Z/soit_param_set07/01"
    export CYLC_TASK_NAMESPACE_HIERARCHY="root soit_param_set07"
    export CYLC_TASK_DEPENDENCIES="20240223T1604Z/pullfetchimage 20240223T1604Z/pulljuliaimage"
    export CYLC_TASK_TRY_NUMBER=1
    export CYLC_TASK_FLOW_NUMBERS=1
    export CYLC_TASK_PARAM_param_set="7"
}

cylc__job__inst__user_env() {
    # TASK RUNTIME ENVIRONMENT:
    export location startdate enddate crs bounding_box centroid_x centroid_y minfloearea maxfloearea project_dir t julia_exec report_dir results_dir fetchdata_dir truecolor_dir reflectance_dir
    location="greenland_sea-100km_by_100km-20030807-20030808,greenland_sea-100km_by_100km-20040623-20040624,greenland_sea-100km_by_100km-20050919-20050920,greenland_sea-100km_by_100km-20060616-20060617,greenland_sea-100km_by_100km-20090314-20090315,greenland_sea-100km_by_100km-20100728-20100729,greenland_sea-100km_by_100km-20120406-20120407,greenland_sea-100km_by_100km-20120508-20120509,greenland_sea-100km_by_100km-20130521-20130522,greenland_sea-100km_by_100km-20150405-20150406,greenland_sea-100km_by_100km-20150430-20150501,greenland_sea-100km_by_100km-20150513-20150514,greenland_sea-100km_by_100km-20160811-20160812,greenland_sea-100km_by_100km-20170805-20170806,greenland_sea-100km_by_100km-20180610-20180611,greenland_sea-100km_by_100km-20200318-20200319,greenland_sea-100km_by_100km-20210921-20210922,greenland_sea-100km_by_100km-20220316-20220317,greenland_sea-100km_by_100km-20220723-20220724,greenland_sea-100km_by_100km-20220728-20220729,greenland_sea-100km_by_100km-20220919-20220920"
    startdate="2003-08-07,2004-06-23,2005-09-19,2006-06-16,2009-03-14,2010-07-28,2012-04-06,2012-05-08,2013-05-21,2015-04-05,2015-04-30,2015-05-13,2016-08-11,2017-08-05,2018-06-10,2020-03-18,2021-09-21,2022-03-16,2022-07-23,2022-07-28,2022-09-19"
    enddate="2003-08-08,2004-06-24,2005-09-20,2006-06-17,2009-03-15,2010-07-29,2012-04-07,2012-05-09,2013-05-22,2015-04-06,2015-05-01,2015-05-14,2016-08-12,2017-08-06,2018-06-11,2020-03-19,2021-09-22,2022-03-17,2022-07-24,2022-07-29,2022-09-20"
    crs="epsg3413"
    bounding_box="812500.00036@-687500.00032@912500.00036@-787500.00032,762500.00015@-737500.00014@862500.00015@-837500.00014,587500.00007@-1312500.00025@687500.00007@-1412500.00025,537500.0002@-762500.00027@637500.0002@-862500.00027,1087499.99983@-687499.99997@1187499.99983@-787499.99997,787500.0003@-1137500.00043@887500.0003@-1237500.00043,812500.00001@-962500.00002@912500.00001@-1062500.00002,1262499.99987@-512499.99984@1362499.99987@-612499.99984,887500.00023@-937500.00025@987500.00023@-1037500.00025,1262499.99979@-662499.99994@1362499.99979@-762499.99994,837500.00016@-1112500.0002@937500.00016@-1212500.0002,837500.00015@-912500.00017@937500.00015@-1012500.00017,712500.0001@-762500.00009@812500.0001@-862500.00009,562500.00003@-1012499.99989@662500.00003@-1112499.99989,737500.00022@-1712500.00009@837500.00022@-1812500.00009,1312500.00049@-662500.00016@1412500.00049@-762500.00016,512499.99996@-612499.99994@612499.99996@-712499.99994,1262499.99987@-512499.99984@1362499.99987@-612499.99984,762500.00031@-912500.00036@862500.00031@-1012500.00036,612500.00002@-1187500.00026@712500.00002@-1287500.00026,587500.00005@-912499.9999@687500.00005@-1012499.9999"
    centroid_x="79.55205034,79.58235715,76.17841765,80.76347686,77.53295999,76.64418678,77.76663966,76.87351863,77.47838283,76.27711843,76.5582575,77.95694517,79.74039879,78.7138949,72.31571697,75.87551184,81.9897567,76.87351863,78.41046704,77.09488198,79.37206286"
    centroid_y="4.467159061,0.8951737102,-19.92558066,-9.130176482,12.04257514,-9.80609276,-4.57392126,21.80140949,-1.487867529,16.50436138,-7.640406761,-2.32153059,-1.818302964,-15.0378159,-20.92450174,17.39332215,-4.666858371,21.80140949,-4.830419958,-16.83747263,-11.48199135"
    minfloearea="300"
    maxfloearea="90000"
    project_dir=~/"ice-floe-tracker-pipeline"
    t="${CYLC_WORKFLOW_INITIAL_CYCLE_POINT}"
    julia_exec="/usr/local/julia/bin/julia"
    report_dir="$project_dir/"workflow/report""
    results_dir="$project_dir/"results"/$t"
    fetchdata_dir="$project_dir/"resources"/$t"
    truecolor_dir="$fetchdata_dir/"truecolor""
    reflectance_dir="$fetchdata_dir/"reflectance""
}

cylc__job__inst__script() {
# SCRIPT:
i=${CYLC_TASK_PARAM_param_set}
location_array=( $(echo $location | sed -e 's/,/ /g') )
startdate_array=( $(echo $startdate | sed -e 's/,/ /g') )
enddate_array=( $(echo $enddate | sed -e 's/,/ /g') )
centroid_x_array=( $(echo $centroid_x| sed -e 's/,/ /g') )
centroid_y_array=( $(echo $centroid_y | sed -e 's/,/ /g') )

apptainer exec --bind $results_dir/${location_array[$i]}/soit:/tmp $project_dir/fetchdata.simg python3 /usr/local/bin/pass_time_cylc.py --startdate ${startdate_array[$i]} --enddate ${enddate_array[$i]} --csvoutpath /tmp --centroid_lat ${centroid_x_array[$i]} --centroid_lon ${centroid_y_array[$i]} --SPACEUSER $SPACEUSER --SPACEPSWD $SPACEPSWD
}

CYLC_RUN_DIR="${CYLC_RUN_DIR:-$HOME/cylc-run}"
. "${CYLC_RUN_DIR}/${CYLC_WORKFLOW_ID}/.service/etc/job.sh"
cylc__job__main

#EOF: 20240223T1604Z/soit_param_set07/01
