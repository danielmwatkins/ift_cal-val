#!/bin/bash -l
#
# ++++ THIS IS A CYLC JOB SCRIPT ++++
# Workflow: barents-kara_seas/run1
# Task: 20240221T1715Z/extractfeatures_param_set16
# Job log directory: 20240221T1715Z/extractfeatures_param_set16/01
# Job runner: slurm
# Execution time limit: 3600.0

# DIRECTIVES:
#SBATCH --job-name=extractfeatures_param_set16.20240221T1715Z.barents-kara_seas/run1
#SBATCH --output=cylc-run/barents-kara_seas/run1/log/job/20240221T1715Z/extractfeatures_param_set16/01/job.out
#SBATCH --error=cylc-run/barents-kara_seas/run1/log/job/20240221T1715Z/extractfeatures_param_set16/01/job.err
#SBATCH --time=60:00
#SBATCH --mem=18G
#SBATCH --cpus-per-task=2
if [[ $1 == 'noreinvoke' ]]; then
    shift
else
    exec bash -l "$0" noreinvoke "$@"
fi

CYLC_FAIL_SIGNALS='EXIT ERR TERM XCPU'
export CYLC_VERBOSE=false
export CYLC_DEBUG=false
export CYLC_VERSION='8.2.1'
export CYLC_WORKFLOW_ID="barents-kara_seas/run1"

cylc__job__inst__cylc_env() {
    # CYLC WORKFLOW ENVIRONMENT:
    export CYLC_CYCLING_MODE="gregorian"
    export CYLC_UTC="False"
    export CYLC_WORKFLOW_FINAL_CYCLE_POINT="None"
    export CYLC_WORKFLOW_INITIAL_CYCLE_POINT="20240221T1715Z"
    export CYLC_WORKFLOW_NAME="barents-kara_seas"
    export CYLC_WORKFLOW_NAME_BASE="barents-kara_seas"
    export CYLC_WORKFLOW_UUID="5a5d5723-d268-45cf-800a-3bd7ca86c501"

    # CYLC TASK ENVIRONMENT:
    export CYLC_TASK_COMMS_METHOD=zmq
    export CYLC_TASK_JOB="20240221T1715Z/extractfeatures_param_set16/01"
    export CYLC_TASK_NAMESPACE_HIERARCHY="root extractfeatures_param_set16"
    export CYLC_TASK_DEPENDENCIES="20240221T1715Z/preprocess_param_set16"
    export CYLC_TASK_TRY_NUMBER=1
    export CYLC_TASK_FLOW_NUMBERS=1
    export CYLC_TASK_PARAM_param_set="16"
}

cylc__job__inst__user_env() {
    # TASK RUNTIME ENVIRONMENT:
    export location startdate enddate crs bounding_box centroid_x centroid_y minfloearea maxfloearea project_dir t julia_exec report_dir results_dir fetchdata_dir truecolor_dir reflectance_dir
    location="barents-kara_seas-100km_by_100km-20030902-20030903,barents-kara_seas-100km_by_100km-20040519-20040520,barents-kara_seas-100km_by_100km-20040916-20040917,barents-kara_seas-100km_by_100km-20050718-20050719,barents-kara_seas-100km_by_100km-20090302-20090303,barents-kara_seas-100km_by_100km-20100311-20100312,barents-kara_seas-100km_by_100km-20110510-20110511,barents-kara_seas-100km_by_100km-20110601-20110602,barents-kara_seas-100km_by_100km-20110805-20110806,barents-kara_seas-100km_by_100km-20130422-20130423,barents-kara_seas-100km_by_100km-20130924-20130925,barents-kara_seas-100km_by_100km-20140501-20140502,barents-kara_seas-100km_by_100km-20140621-20140622,barents-kara_seas-100km_by_100km-20140708-20140709,barents-kara_seas-100km_by_100km-20150303-20150304,barents-kara_seas-100km_by_100km-20150426-20150427,barents-kara_seas-100km_by_100km-20150428-20150429,barents-kara_seas-100km_by_100km-20160829-20160830,barents-kara_seas-100km_by_100km-20170621-20170622,barents-kara_seas-100km_by_100km-20200701-20200702,barents-kara_seas-100km_by_100km-20210825-20210826"
    startdate="2003-09-02,2004-05-19,2004-09-16,2005-07-18,2009-03-02,2010-03-11,2011-05-10,2011-06-01,2011-08-05,2013-04-22,2013-09-24,2014-05-01,2014-06-21,2014-07-08,2015-03-03,2015-04-26,2015-04-28,2016-08-29,2017-06-21,2020-07-01,2021-08-25"
    enddate="2003-09-03,2004-05-20,2004-09-17,2005-07-19,2009-03-03,2010-03-12,2011-05-11,2011-06-02,2011-08-06,2013-04-23,2013-09-25,2014-05-02,2014-06-22,2014-07-09,2015-03-04,2015-04-27,2015-04-29,2016-08-30,2017-06-22,2020-07-02,2021-08-26"
    crs="epsg3413"
    bounding_box="1137499.99993@737499.99991@1237499.99993@637499.99991,1362499.99967@412499.99995@1462499.99967@312499.99995,962500.00019@437500.00007@1062500.00019@337500.00007,962500.00013@537500.00005@1062500.00013@437500.00005,1362500.00006@-237500.00011@1462500.00006@-337500.00011,1187499.99956@587499.99976@1287499.99956@487499.99976,1312499.99972@262500.0@1412499.99972@162500.0,1762500.00009@612500.00006@1862500.00009@512500.00006,987499.99986@387499.99992@1087499.99986@287499.99992,1412500.00051@-37499.9999@1512500.00051@-137499.9999,2062499.99983@912500.00001@2162499.99983@812500.00001,1312499.99976@437500.00005@1412499.99976@337500.00005,1212500.00037@-112500.00002@1312500.00037@-212500.00002,1012500.00031@137499.99994@1112500.00031@37499.99994,2062499.99985@462499.99991@2162499.99985@362499.99991,1012499.99968@-212499.99986@1112499.99968@-312499.99986,2137500.00034@412500.00013@2237500.00034@312500.00013,2087499.99976@912499.99984@2187499.99976@812499.99984,1162500.00032@312499.99998@1262500.00032@212499.99998,1012499.99977@412499.99996@1112499.99977@312499.99996,2087499.99976@912499.99984@2187499.99976@812499.99984"
    centroid_x="77.38241923,76.59724557,80.01651358,79.65342561,76.75043391,77.59201207,77.32023766,72.61040758,79.95331912,76.53492076,69.15972085,76.97767858,78.2886611,80.18168529,70.31863357,79.9218734,69.73653112,68.95267593,78.58415768,79.66361898,68.95267593"
    centroid_y="75.06858282,59.39359297,65.94265055,70.70995378,33.49518467,68.47739989,53.86462339,62.2414594,63.01976928,41.57612876,67.20940916,60.87594651,37.6656212,49.70785224,56.04890567,31.1224702,54.40922141,66.97450799,57.21571913,63.83843356,66.97450799"
    minfloearea="300"
    maxfloearea="90000"
    project_dir=~/"ice-floe-tracker-pipeline"
    t="${CYLC_WORKFLOW_INITIAL_CYCLE_POINT}"
    julia_exec="/usr/local/julia/bin/julia"
    report_dir="$project_dir/"workflow/report""
    results_dir="$project_dir/"results"/$t"
    fetchdata_dir="$project_dir/"resources"/$t"
    truecolor_dir="$fetchdata_dir/"truecolor""
    reflectance_dir="$fetchdata_dir/"reflectance""
}

cylc__job__inst__script() {
# SCRIPT:
i=${CYLC_TASK_PARAM_param_set}
location_array=( $(echo $location | sed -e 's/,/ /g') )
preprocess_dir=$results_dir/${location_array[$i]}/preprocess

apptainer exec --env JULIA_DEPOT_PATH=$HOME/.julia:/opt/julia --bind $preprocess_dir:/tmp,$report_dir:/usr/local/report $project_dir/icefloetracker-julia.simg $julia_exec -t auto /usr/local/bin/ice-floe-tracker.jl extractfeatures -i $preprocess_dir -o /tmp --minarea $minfloearea --maxarea $maxfloearea
}

CYLC_RUN_DIR="${CYLC_RUN_DIR:-$HOME/cylc-run}"
. "${CYLC_RUN_DIR}/${CYLC_WORKFLOW_ID}/.service/etc/job.sh"
cylc__job__main

#EOF: 20240221T1715Z/extractfeatures_param_set16/01
